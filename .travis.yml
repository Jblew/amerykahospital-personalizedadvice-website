language: ruby
sudo: false
cache: bundler
rvm:
  - 2.3

before_install:
  - npm --prefix="./public" install
  - npm --prefix="./roles-manager-app" ci
  - npm --prefix="./professional-panel" ci

script:
  # Build public website
  - (cd public && bundle exec jekyll build)
  # Build roles manager app
  - npm --prefix="./roles-manager-app" run build
  - mv ./roles-manager-app/dist ./public/_site/role-management
  # Build medical professional app
  - npm --prefix="./professional-panel" run build
  - mv ./professional-panel/dist ./public/_site/professional-panel
  # Test links on public website
  - (cd public && bundle exec htmlproofer ./_site)

branches:
  only:
    - master

env:
  global:
    - NOKOGIRI_USE_SYSTEM_LIBRARIES=true # speeds up installation of html-proofer

addons:
  apt:
    packages:
      - libcurl4-openssl-dev

deploy:
  provider: firebase
  skip_cleanup: true
  on:
    tags: false
    branch: master
